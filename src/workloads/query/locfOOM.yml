SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload is used to make the server OOM by leaking cursors. Based on locf.yml.

  To learn more about partitions, please check out the docs here:
  https://docs.mongodb.com/manual/reference/operator/aggregation/setWindowFields/

Actors:
- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &db test
    Threads: 1
    CollectionCount: 1
    DocumentCount: 40000
    BatchSize: &batchSize 100
    Document:
      part1: {^Choose: {from: [1, 2, 3, 4]}}
      part2: {^Choose: {from: [1, 2, 3, 4]}}
      numeric: {^Choose: {from: [
        {^RandomInt: {min: -100, max: 100}},
        {^RandomDouble: { min: 0.0, max: 500.0 }},
        null], weights: [1, 1, 8]}}
      string: {^Choose: {from: [
        {^RandomString: {length: 15}},
        null], weights: [1, 4]}}
      date: {^Choose: {from: [
        {^RandomDate: {min: "2021-01-01", max: "2023-01-01"}},
        null], weights: [2, 8]}}
      randomType: {^Choose: {from: [
        {^RandomInt: {min: -100, max: 100}},
        {^RandomDouble: { min: 0.0, max: 500.0 }},
        {^RandomDate: {min: "2021-01-01", max: "2023-01-01"}},
        {^RandomString: {length: 15}},
        null], weights: [1, 1, 1, 1, 5]}}
  - Nop: true

- Name: LocfNumericWithoutPartition
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Duration: 60 minutes
    Database: *db
    Operations:
    - OperationMetricsName: TestNumericWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
              numeric: {
                $locf: "$numeric"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}

- Name: LocfRandomTypeWithoutPartition
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Duration: 60 minutes
    Database: *db
    Operations:
    - OperationMetricsName: TestRandomTypeWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
              randomType: {
                $locf: "$randomType"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}

- Name: LocfMultipleOutputWithoutPartition
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Duration: 60 minutes
    Database: *db
    Operations:
    - OperationMetricsName: TestMultipleOutputWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
              numeric: {
                $locf: "$numeric"},
              string: {
                $locf: "$string"},
              date: {
                $locf: "$date"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}

- Name: LocfDateWithSinglePartition
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Duration: 60 minutes
    Database: *db
    Operations:
    - OperationMetricsName: TestDateWithSinglePartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: "$part1",
            output: {
              date: {
                $locf: "$date"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - replica
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
